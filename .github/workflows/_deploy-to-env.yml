name: Deploy to environment

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment to deploy"
        required: true
        type: string
    secrets:
      ECR_ROLE_TO_ASSUME:
        required: true
      KUBE_CERT:
        required: true
      KUBE_CLUSTER:
        required: true
      KUBE_TOKEN:
        required: true
      KUBE_NAMESPACE:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Login to AWS ECR container repo
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/ecr-auth@main
        with:
          ecr_region: ${{ vars.ECR_REGION }}
          ecr_role: ${{ secrets.ECR_ROLE_TO_ASSUME }}
          role-session-name: deployment

      - name: Authenticate with Kubernetes cluster in Cloud Platform
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/authenticate_to_cluster@main
        with:
          kube-cert: ${{ secrets.KUBE_CERT }}
          kube-token: ${{ secrets.KUBE_TOKEN }}
          kube-cluster: ${{ secrets.KUBE_CLUSTER }}
          kube-namespace: ${{ secrets.KUBE_NAMESPACE }}

#      - name: Helm deploy to ${{ inputs.environment }}
#        run: |
#          cd kubernetes/helm_deploy/${{ inputs.app_name }}
#          helm upgrade ${{ inputs.app_name }} -f values.yaml -f values-${{ inputs.environment }}.yaml . --namespace ${{ secrets.KUBE_NAMESPACE }} --install --set image.repository="${{ env.REGISTRY }}/${{ vars.ECR_REPOSITORY }}" --set image.tag="${{ env.IMAGE_TAG }}"
#        env:
#          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
#          IMAGE_TAG: ${{ inputs.repo_name }}-${{ github.sha }} # Tags ECR image with commit sha