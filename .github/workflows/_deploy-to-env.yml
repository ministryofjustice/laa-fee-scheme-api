name: Deploy to environment

on:
  workflow_call:
    inputs:
      environment:
        description: "Target environment to deploy"
        required: true
        type: string
    secrets:
      ECR_ROLE_TO_ASSUME:
        required: true
      KUBE_CERT:
        required: true
      KUBE_CLUSTER:
        required: true
      KUBE_TOKEN:
        required: true
      KUBE_NAMESPACE:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    permissions:
      id-token: write # This is required for requesting the JWT
      contents: read # This is required for actions/checkout

    steps:
      - uses: actions/checkout@v4

      - name: Login to AWS ECR container repo
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/ecr-auth@main
        with:
          ecr_region: ${{ vars.ECR_REGION }}
          ecr_role: ${{ secrets.ECR_ROLE_TO_ASSUME }}
          role-session-name: deployment

      - name: Authenticate with Kubernetes cluster in Cloud Platform
        id: auth
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/authenticate_to_cluster@main
        with:
          kube-cert: ${{ secrets.KUBE_CERT }}
          kube-token: ${{ secrets.KUBE_TOKEN }}
          kube-cluster: ${{ secrets.KUBE_CLUSTER }}
          kube-namespace: ${{ secrets.KUBE_NAMESPACE }}

      - name: Authenticate with Kubernetes cluster in Cloud Platform
        uses: ministryofjustice/laa-reusable-github-actions/.github/actions/helm-deploy@main
        with:
          k8s_namespace: ${{ secrets.KUBE_NAMESPACE }}
          helm_release_name: laa-fee-scheme-api-${{ inputs.environment }}
          helm_chart: laa-fee-scheme-api
          helm_values_path: values-${{ inputs.environment }}.yaml
          image_registry: ${{ steps.auth.outputs.image_registry }}
          image_repo: ${{ vars.ECR_REPOSITORY }}
          image_tag: $${{ github.sha }}
